// @ts-check

import _ from 'lodash';

const getNextId = () => Number(_.uniqueId());

const buildState = defaultState => {
  const generalChannelId = getNextId();
  const randomChannelId = getNextId();
  const state = {
    channels: [{ id: generalChannelId, name: 'general', removable: false }, { id: randomChannelId, name: 'random', removable: false }],
    messages: [],
    currentChannelId: generalChannelId
  };

  if (defaultState.messages) {
    state.messages.push(...defaultState.messages);
  }
  if (defaultState.channels) {
    state.channels.push(...defaultState.channels);
  }
  if (defaultState.currentChannelId) {
    state.currentChannelId = defaultState.currentChannelId;
  }

  return state;
};

export default ((app, io, defaultState = {}) => {
  const state = buildState(defaultState);

  app.get('/', (_req, reply) => {
    reply.view('index.pug', { gon: state });
  }).get('/api/v1/channels', (_req, reply) => {
    const resources = state.channels.map(c => ({
      type: 'channels',
      id: c.id,
      attributes: c
    }));
    const response = {
      data: resources
    };
    reply.send(response);
  }).post('/api/v1/channels', (req, reply) => {
    const { data: { attributes: { name } } } = req.body;
    const channel = {
      name,
      removable: true,
      id: getNextId()
    };
    state.channels.push(channel);
    reply.code(201);
    const data = {
      data: {
        type: 'channels',
        id: channel.id,
        attributes: channel
      }
    };

    reply.send(data);
    io.emit('newChannel', data); // отправить событие на все подключенные сокеты
  }).delete('/api/v1/channels/:id', (req, reply) => {
    const channelId = Number(req.params.id);
    state.channels = state.channels.filter(c => c.id !== channelId);
    state.messages = state.messages.filter(m => m.channelId !== channelId);
    reply.code(204);
    const data = {
      data: {
        type: 'channels',
        id: channelId
      }
    };

    reply.send(data);
    io.emit('removeChannel', data); // отправить событие на все подключенные сокеты
  }).patch('/api/v1/channels/:id', (req, reply) => {
    const channelId = Number(req.params.id);
    const channel = state.channels.find(c => c.id === channelId);

    const { data: { attributes } } = req.body;
    channel.name = attributes.name;

    const data = {
      data: {
        type: 'channels',
        id: channelId,
        attributes: channel
      }
    };
    reply.send(data);
    io.emit('renameChannel', data); // отправить событие на все подключенные сокеты
  }).get('/api/v1/channels/:channelId/messages', (req, reply) => {
    const messages = state.messages.filter(m => m.channelId === Number(req.params.channelId));
    const resources = messages.map(m => ({
      type: 'messages',
      id: m.id,
      attributes: m
    }));
    const response = {
      data: resources
    };
    reply.send(response);
  }).post('/api/v1/channels/:channelId/messages', (req, reply) => {
    const { data: { attributes: { userName, text } } } = req.body;
    const message = {
      userName,
      text,
      channelId: Number(req.params.channelId),
      id: getNextId()
    };
    state.messages.push(message);
    reply.code(201);
    const data = {
      data: {
        type: 'messages',
        id: message.id,
        attributes: message
      }
    };
    reply.send(data);
    io.emit('newMessage', data); // отправить событие на все подключенные сокеты
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9yb3V0ZXMuanMiXSwibmFtZXMiOlsiXyIsImdldE5leHRJZCIsIk51bWJlciIsInVuaXF1ZUlkIiwiYnVpbGRTdGF0ZSIsImRlZmF1bHRTdGF0ZSIsImdlbmVyYWxDaGFubmVsSWQiLCJyYW5kb21DaGFubmVsSWQiLCJzdGF0ZSIsImNoYW5uZWxzIiwiaWQiLCJuYW1lIiwicmVtb3ZhYmxlIiwibWVzc2FnZXMiLCJjdXJyZW50Q2hhbm5lbElkIiwicHVzaCIsImFwcCIsImlvIiwiZ2V0IiwiX3JlcSIsInJlcGx5IiwidmlldyIsImdvbiIsInJlc291cmNlcyIsIm1hcCIsImMiLCJ0eXBlIiwiYXR0cmlidXRlcyIsInJlc3BvbnNlIiwiZGF0YSIsInNlbmQiLCJwb3N0IiwicmVxIiwiYm9keSIsImNoYW5uZWwiLCJjb2RlIiwiZW1pdCIsImRlbGV0ZSIsImNoYW5uZWxJZCIsInBhcmFtcyIsImZpbHRlciIsIm0iLCJwYXRjaCIsImZpbmQiLCJ1c2VyTmFtZSIsInRleHQiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxPQUFPQSxDQUFQLE1BQWMsUUFBZDs7QUFFQSxNQUFNQyxZQUFZLE1BQU1DLE9BQU9GLEVBQUVHLFFBQUYsRUFBUCxDQUF4Qjs7QUFFQSxNQUFNQyxhQUFjQyxZQUFELElBQWtCO0FBQ25DLFFBQU1DLG1CQUFtQkwsV0FBekI7QUFDQSxRQUFNTSxrQkFBa0JOLFdBQXhCO0FBQ0EsUUFBTU8sUUFBUTtBQUNaQyxjQUFVLENBQ1IsRUFBRUMsSUFBSUosZ0JBQU4sRUFBd0JLLE1BQU0sU0FBOUIsRUFBeUNDLFdBQVcsS0FBcEQsRUFEUSxFQUVSLEVBQUVGLElBQUlILGVBQU4sRUFBdUJJLE1BQU0sUUFBN0IsRUFBdUNDLFdBQVcsS0FBbEQsRUFGUSxDQURFO0FBS1pDLGNBQVUsRUFMRTtBQU1aQyxzQkFBa0JSO0FBTk4sR0FBZDs7QUFTQSxNQUFJRCxhQUFhUSxRQUFqQixFQUEyQjtBQUN6QkwsVUFBTUssUUFBTixDQUFlRSxJQUFmLENBQW9CLEdBQUdWLGFBQWFRLFFBQXBDO0FBQ0Q7QUFDRCxNQUFJUixhQUFhSSxRQUFqQixFQUEyQjtBQUN6QkQsVUFBTUMsUUFBTixDQUFlTSxJQUFmLENBQW9CLEdBQUdWLGFBQWFJLFFBQXBDO0FBQ0Q7QUFDRCxNQUFJSixhQUFhUyxnQkFBakIsRUFBbUM7QUFDakNOLFVBQU1NLGdCQUFOLEdBQXlCVCxhQUFhUyxnQkFBdEM7QUFDRDs7QUFFRCxTQUFPTixLQUFQO0FBQ0QsQ0F2QkQ7O0FBeUJBLGdCQUFlLENBQUNRLEdBQUQsRUFBTUMsRUFBTixFQUFVWixlQUFlLEVBQXpCLEtBQWdDO0FBQzdDLFFBQU1HLFFBQVFKLFdBQVdDLFlBQVgsQ0FBZDs7QUFFQVcsTUFDR0UsR0FESCxDQUNPLEdBRFAsRUFDWSxDQUFDQyxJQUFELEVBQU9DLEtBQVAsS0FBaUI7QUFDekJBLFVBQU1DLElBQU4sQ0FBVyxXQUFYLEVBQXdCLEVBQUVDLEtBQUtkLEtBQVAsRUFBeEI7QUFDRCxHQUhILEVBSUdVLEdBSkgsQ0FJTyxrQkFKUCxFQUkyQixDQUFDQyxJQUFELEVBQU9DLEtBQVAsS0FBaUI7QUFDeEMsVUFBTUcsWUFBWWYsTUFBTUMsUUFBTixDQUFlZSxHQUFmLENBQW9CQyxDQUFELEtBQVE7QUFDM0NDLFlBQU0sVUFEcUM7QUFFM0NoQixVQUFJZSxFQUFFZixFQUZxQztBQUczQ2lCLGtCQUFZRjtBQUgrQixLQUFSLENBQW5CLENBQWxCO0FBS0EsVUFBTUcsV0FBVztBQUNmQyxZQUFNTjtBQURTLEtBQWpCO0FBR0FILFVBQU1VLElBQU4sQ0FBV0YsUUFBWDtBQUNELEdBZEgsRUFlR0csSUFmSCxDQWVRLGtCQWZSLEVBZTRCLENBQUNDLEdBQUQsRUFBTVosS0FBTixLQUFnQjtBQUN4QyxVQUFNLEVBQUVTLE1BQU0sRUFBRUYsWUFBWSxFQUFFaEIsSUFBRixFQUFkLEVBQVIsS0FBcUNxQixJQUFJQyxJQUEvQztBQUNBLFVBQU1DLFVBQVU7QUFDZHZCLFVBRGM7QUFFZEMsaUJBQVcsSUFGRztBQUdkRixVQUFJVDtBQUhVLEtBQWhCO0FBS0FPLFVBQU1DLFFBQU4sQ0FBZU0sSUFBZixDQUFvQm1CLE9BQXBCO0FBQ0FkLFVBQU1lLElBQU4sQ0FBVyxHQUFYO0FBQ0EsVUFBTU4sT0FBTztBQUNYQSxZQUFNO0FBQ0pILGNBQU0sVUFERjtBQUVKaEIsWUFBSXdCLFFBQVF4QixFQUZSO0FBR0ppQixvQkFBWU87QUFIUjtBQURLLEtBQWI7O0FBUUFkLFVBQU1VLElBQU4sQ0FBV0QsSUFBWDtBQUNBWixPQUFHbUIsSUFBSCxDQUFRLFlBQVIsRUFBc0JQLElBQXRCLEVBbEJ3QyxDQWtCWDtBQUM5QixHQWxDSCxFQW1DR1EsTUFuQ0gsQ0FtQ1Usc0JBbkNWLEVBbUNrQyxDQUFDTCxHQUFELEVBQU1aLEtBQU4sS0FBZ0I7QUFDOUMsVUFBTWtCLFlBQVlwQyxPQUFPOEIsSUFBSU8sTUFBSixDQUFXN0IsRUFBbEIsQ0FBbEI7QUFDQUYsVUFBTUMsUUFBTixHQUFpQkQsTUFBTUMsUUFBTixDQUFlK0IsTUFBZixDQUF1QmYsQ0FBRCxJQUFPQSxFQUFFZixFQUFGLEtBQVM0QixTQUF0QyxDQUFqQjtBQUNBOUIsVUFBTUssUUFBTixHQUFpQkwsTUFBTUssUUFBTixDQUFlMkIsTUFBZixDQUF1QkMsQ0FBRCxJQUFPQSxFQUFFSCxTQUFGLEtBQWdCQSxTQUE3QyxDQUFqQjtBQUNBbEIsVUFBTWUsSUFBTixDQUFXLEdBQVg7QUFDQSxVQUFNTixPQUFPO0FBQ1hBLFlBQU07QUFDSkgsY0FBTSxVQURGO0FBRUpoQixZQUFJNEI7QUFGQTtBQURLLEtBQWI7O0FBT0FsQixVQUFNVSxJQUFOLENBQVdELElBQVg7QUFDQVosT0FBR21CLElBQUgsQ0FBUSxlQUFSLEVBQXlCUCxJQUF6QixFQWI4QyxDQWFkO0FBQ2pDLEdBakRILEVBa0RHYSxLQWxESCxDQWtEUyxzQkFsRFQsRUFrRGlDLENBQUNWLEdBQUQsRUFBTVosS0FBTixLQUFnQjtBQUM3QyxVQUFNa0IsWUFBWXBDLE9BQU84QixJQUFJTyxNQUFKLENBQVc3QixFQUFsQixDQUFsQjtBQUNBLFVBQU13QixVQUFVMUIsTUFBTUMsUUFBTixDQUFla0MsSUFBZixDQUFxQmxCLENBQUQsSUFBT0EsRUFBRWYsRUFBRixLQUFTNEIsU0FBcEMsQ0FBaEI7O0FBRUEsVUFBTSxFQUFFVCxNQUFNLEVBQUVGLFVBQUYsRUFBUixLQUEyQkssSUFBSUMsSUFBckM7QUFDQUMsWUFBUXZCLElBQVIsR0FBZWdCLFdBQVdoQixJQUExQjs7QUFFQSxVQUFNa0IsT0FBTztBQUNYQSxZQUFNO0FBQ0pILGNBQU0sVUFERjtBQUVKaEIsWUFBSTRCLFNBRkE7QUFHSlgsb0JBQVlPO0FBSFI7QUFESyxLQUFiO0FBT0FkLFVBQU1VLElBQU4sQ0FBV0QsSUFBWDtBQUNBWixPQUFHbUIsSUFBSCxDQUFRLGVBQVIsRUFBeUJQLElBQXpCLEVBZjZDLENBZWI7QUFDakMsR0FsRUgsRUFtRUdYLEdBbkVILENBbUVPLHNDQW5FUCxFQW1FK0MsQ0FBQ2MsR0FBRCxFQUFNWixLQUFOLEtBQWdCO0FBQzNELFVBQU1QLFdBQVdMLE1BQU1LLFFBQU4sQ0FBZTJCLE1BQWYsQ0FBdUJDLENBQUQsSUFBT0EsRUFBRUgsU0FBRixLQUFnQnBDLE9BQU84QixJQUFJTyxNQUFKLENBQVdELFNBQWxCLENBQTdDLENBQWpCO0FBQ0EsVUFBTWYsWUFBWVYsU0FBU1csR0FBVCxDQUFjaUIsQ0FBRCxLQUFRO0FBQ3JDZixZQUFNLFVBRCtCO0FBRXJDaEIsVUFBSStCLEVBQUUvQixFQUYrQjtBQUdyQ2lCLGtCQUFZYztBQUh5QixLQUFSLENBQWIsQ0FBbEI7QUFLQSxVQUFNYixXQUFXO0FBQ2ZDLFlBQU1OO0FBRFMsS0FBakI7QUFHQUgsVUFBTVUsSUFBTixDQUFXRixRQUFYO0FBQ0QsR0E5RUgsRUErRUdHLElBL0VILENBK0VRLHNDQS9FUixFQStFZ0QsQ0FBQ0MsR0FBRCxFQUFNWixLQUFOLEtBQWdCO0FBQzVELFVBQU0sRUFBRVMsTUFBTSxFQUFFRixZQUFZLEVBQUVpQixRQUFGLEVBQVlDLElBQVosRUFBZCxFQUFSLEtBQStDYixJQUFJQyxJQUF6RDtBQUNBLFVBQU1hLFVBQVU7QUFDZEYsY0FEYztBQUVkQyxVQUZjO0FBR2RQLGlCQUFXcEMsT0FBTzhCLElBQUlPLE1BQUosQ0FBV0QsU0FBbEIsQ0FIRztBQUlkNUIsVUFBSVQ7QUFKVSxLQUFoQjtBQU1BTyxVQUFNSyxRQUFOLENBQWVFLElBQWYsQ0FBb0IrQixPQUFwQjtBQUNBMUIsVUFBTWUsSUFBTixDQUFXLEdBQVg7QUFDQSxVQUFNTixPQUFPO0FBQ1hBLFlBQU07QUFDSkgsY0FBTSxVQURGO0FBRUpoQixZQUFJb0MsUUFBUXBDLEVBRlI7QUFHSmlCLG9CQUFZbUI7QUFIUjtBQURLLEtBQWI7QUFPQTFCLFVBQU1VLElBQU4sQ0FBV0QsSUFBWDtBQUNBWixPQUFHbUIsSUFBSCxDQUFRLFlBQVIsRUFBc0JQLElBQXRCLEVBbEI0RCxDQWtCL0I7QUFDOUIsR0FsR0g7QUFtR0QsQ0F0R0QiLCJmaWxlIjoicm91dGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLWNoZWNrXG5cbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmNvbnN0IGdldE5leHRJZCA9ICgpID0+IE51bWJlcihfLnVuaXF1ZUlkKCkpO1xuXG5jb25zdCBidWlsZFN0YXRlID0gKGRlZmF1bHRTdGF0ZSkgPT4ge1xuICBjb25zdCBnZW5lcmFsQ2hhbm5lbElkID0gZ2V0TmV4dElkKCk7XG4gIGNvbnN0IHJhbmRvbUNoYW5uZWxJZCA9IGdldE5leHRJZCgpO1xuICBjb25zdCBzdGF0ZSA9IHtcbiAgICBjaGFubmVsczogW1xuICAgICAgeyBpZDogZ2VuZXJhbENoYW5uZWxJZCwgbmFtZTogJ2dlbmVyYWwnLCByZW1vdmFibGU6IGZhbHNlIH0sXG4gICAgICB7IGlkOiByYW5kb21DaGFubmVsSWQsIG5hbWU6ICdyYW5kb20nLCByZW1vdmFibGU6IGZhbHNlIH0sXG4gICAgXSxcbiAgICBtZXNzYWdlczogW10sXG4gICAgY3VycmVudENoYW5uZWxJZDogZ2VuZXJhbENoYW5uZWxJZCxcbiAgfTtcblxuICBpZiAoZGVmYXVsdFN0YXRlLm1lc3NhZ2VzKSB7XG4gICAgc3RhdGUubWVzc2FnZXMucHVzaCguLi5kZWZhdWx0U3RhdGUubWVzc2FnZXMpO1xuICB9XG4gIGlmIChkZWZhdWx0U3RhdGUuY2hhbm5lbHMpIHtcbiAgICBzdGF0ZS5jaGFubmVscy5wdXNoKC4uLmRlZmF1bHRTdGF0ZS5jaGFubmVscyk7XG4gIH1cbiAgaWYgKGRlZmF1bHRTdGF0ZS5jdXJyZW50Q2hhbm5lbElkKSB7XG4gICAgc3RhdGUuY3VycmVudENoYW5uZWxJZCA9IGRlZmF1bHRTdGF0ZS5jdXJyZW50Q2hhbm5lbElkO1xuICB9XG5cbiAgcmV0dXJuIHN0YXRlO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgKGFwcCwgaW8sIGRlZmF1bHRTdGF0ZSA9IHt9KSA9PiB7XG4gIGNvbnN0IHN0YXRlID0gYnVpbGRTdGF0ZShkZWZhdWx0U3RhdGUpO1xuXG4gIGFwcFxuICAgIC5nZXQoJy8nLCAoX3JlcSwgcmVwbHkpID0+IHtcbiAgICAgIHJlcGx5LnZpZXcoJ2luZGV4LnB1ZycsIHsgZ29uOiBzdGF0ZSB9KTtcbiAgICB9KVxuICAgIC5nZXQoJy9hcGkvdjEvY2hhbm5lbHMnLCAoX3JlcSwgcmVwbHkpID0+IHtcbiAgICAgIGNvbnN0IHJlc291cmNlcyA9IHN0YXRlLmNoYW5uZWxzLm1hcCgoYykgPT4gKHtcbiAgICAgICAgdHlwZTogJ2NoYW5uZWxzJyxcbiAgICAgICAgaWQ6IGMuaWQsXG4gICAgICAgIGF0dHJpYnV0ZXM6IGMsXG4gICAgICB9KSk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgZGF0YTogcmVzb3VyY2VzLFxuICAgICAgfTtcbiAgICAgIHJlcGx5LnNlbmQocmVzcG9uc2UpO1xuICAgIH0pXG4gICAgLnBvc3QoJy9hcGkvdjEvY2hhbm5lbHMnLCAocmVxLCByZXBseSkgPT4ge1xuICAgICAgY29uc3QgeyBkYXRhOiB7IGF0dHJpYnV0ZXM6IHsgbmFtZSB9IH0gfSA9IHJlcS5ib2R5O1xuICAgICAgY29uc3QgY2hhbm5lbCA9IHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgcmVtb3ZhYmxlOiB0cnVlLFxuICAgICAgICBpZDogZ2V0TmV4dElkKCksXG4gICAgICB9O1xuICAgICAgc3RhdGUuY2hhbm5lbHMucHVzaChjaGFubmVsKTtcbiAgICAgIHJlcGx5LmNvZGUoMjAxKTtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0eXBlOiAnY2hhbm5lbHMnLFxuICAgICAgICAgIGlkOiBjaGFubmVsLmlkLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IGNoYW5uZWwsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICByZXBseS5zZW5kKGRhdGEpO1xuICAgICAgaW8uZW1pdCgnbmV3Q2hhbm5lbCcsIGRhdGEpOyAvLyDQvtGC0L/RgNCw0LLQuNGC0Ywg0YHQvtCx0YvRgtC40LUg0L3QsCDQstGB0LUg0L/QvtC00LrQu9GO0YfQtdC90L3Ri9C1INGB0L7QutC10YLRi1xuICAgIH0pXG4gICAgLmRlbGV0ZSgnL2FwaS92MS9jaGFubmVscy86aWQnLCAocmVxLCByZXBseSkgPT4ge1xuICAgICAgY29uc3QgY2hhbm5lbElkID0gTnVtYmVyKHJlcS5wYXJhbXMuaWQpO1xuICAgICAgc3RhdGUuY2hhbm5lbHMgPSBzdGF0ZS5jaGFubmVscy5maWx0ZXIoKGMpID0+IGMuaWQgIT09IGNoYW5uZWxJZCk7XG4gICAgICBzdGF0ZS5tZXNzYWdlcyA9IHN0YXRlLm1lc3NhZ2VzLmZpbHRlcigobSkgPT4gbS5jaGFubmVsSWQgIT09IGNoYW5uZWxJZCk7XG4gICAgICByZXBseS5jb2RlKDIwNCk7XG4gICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdHlwZTogJ2NoYW5uZWxzJyxcbiAgICAgICAgICBpZDogY2hhbm5lbElkLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgcmVwbHkuc2VuZChkYXRhKTtcbiAgICAgIGlvLmVtaXQoJ3JlbW92ZUNoYW5uZWwnLCBkYXRhKTsgLy8g0L7RgtC/0YDQsNCy0LjRgtGMINGB0L7QsdGL0YLQuNC1INC90LAg0LLRgdC1INC/0L7QtNC60LvRjtGH0LXQvdC90YvQtSDRgdC+0LrQtdGC0YtcbiAgICB9KVxuICAgIC5wYXRjaCgnL2FwaS92MS9jaGFubmVscy86aWQnLCAocmVxLCByZXBseSkgPT4ge1xuICAgICAgY29uc3QgY2hhbm5lbElkID0gTnVtYmVyKHJlcS5wYXJhbXMuaWQpO1xuICAgICAgY29uc3QgY2hhbm5lbCA9IHN0YXRlLmNoYW5uZWxzLmZpbmQoKGMpID0+IGMuaWQgPT09IGNoYW5uZWxJZCk7XG5cbiAgICAgIGNvbnN0IHsgZGF0YTogeyBhdHRyaWJ1dGVzIH0gfSA9IHJlcS5ib2R5O1xuICAgICAgY2hhbm5lbC5uYW1lID0gYXR0cmlidXRlcy5uYW1lO1xuXG4gICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdHlwZTogJ2NoYW5uZWxzJyxcbiAgICAgICAgICBpZDogY2hhbm5lbElkLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IGNoYW5uZWwsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgcmVwbHkuc2VuZChkYXRhKTtcbiAgICAgIGlvLmVtaXQoJ3JlbmFtZUNoYW5uZWwnLCBkYXRhKTsgLy8g0L7RgtC/0YDQsNCy0LjRgtGMINGB0L7QsdGL0YLQuNC1INC90LAg0LLRgdC1INC/0L7QtNC60LvRjtGH0LXQvdC90YvQtSDRgdC+0LrQtdGC0YtcbiAgICB9KVxuICAgIC5nZXQoJy9hcGkvdjEvY2hhbm5lbHMvOmNoYW5uZWxJZC9tZXNzYWdlcycsIChyZXEsIHJlcGx5KSA9PiB7XG4gICAgICBjb25zdCBtZXNzYWdlcyA9IHN0YXRlLm1lc3NhZ2VzLmZpbHRlcigobSkgPT4gbS5jaGFubmVsSWQgPT09IE51bWJlcihyZXEucGFyYW1zLmNoYW5uZWxJZCkpO1xuICAgICAgY29uc3QgcmVzb3VyY2VzID0gbWVzc2FnZXMubWFwKChtKSA9PiAoe1xuICAgICAgICB0eXBlOiAnbWVzc2FnZXMnLFxuICAgICAgICBpZDogbS5pZCxcbiAgICAgICAgYXR0cmlidXRlczogbSxcbiAgICAgIH0pKTtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICBkYXRhOiByZXNvdXJjZXMsXG4gICAgICB9O1xuICAgICAgcmVwbHkuc2VuZChyZXNwb25zZSk7XG4gICAgfSlcbiAgICAucG9zdCgnL2FwaS92MS9jaGFubmVscy86Y2hhbm5lbElkL21lc3NhZ2VzJywgKHJlcSwgcmVwbHkpID0+IHtcbiAgICAgIGNvbnN0IHsgZGF0YTogeyBhdHRyaWJ1dGVzOiB7IHVzZXJOYW1lLCB0ZXh0IH0gfSB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBtZXNzYWdlID0ge1xuICAgICAgICB1c2VyTmFtZSxcbiAgICAgICAgdGV4dCxcbiAgICAgICAgY2hhbm5lbElkOiBOdW1iZXIocmVxLnBhcmFtcy5jaGFubmVsSWQpLFxuICAgICAgICBpZDogZ2V0TmV4dElkKCksXG4gICAgICB9O1xuICAgICAgc3RhdGUubWVzc2FnZXMucHVzaChtZXNzYWdlKTtcbiAgICAgIHJlcGx5LmNvZGUoMjAxKTtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0eXBlOiAnbWVzc2FnZXMnLFxuICAgICAgICAgIGlkOiBtZXNzYWdlLmlkLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IG1lc3NhZ2UsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgcmVwbHkuc2VuZChkYXRhKTtcbiAgICAgIGlvLmVtaXQoJ25ld01lc3NhZ2UnLCBkYXRhKTsgLy8g0L7RgtC/0YDQsNCy0LjRgtGMINGB0L7QsdGL0YLQuNC1INC90LAg0LLRgdC1INC/0L7QtNC60LvRjtGH0LXQvdC90YvQtSDRgdC+0LrQtdGC0YtcbiAgICB9KTtcbn07XG4iXX0=