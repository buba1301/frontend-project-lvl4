// @ts-check

import 'core-js/stable';
import 'regenerator-runtime/runtime';

import path from 'path';
import Pug from 'pug';
import socket from 'socket.io';
import fastify from 'fastify';
import pointOfView from 'point-of-view';
import fastifyStatic from 'fastify-static';
// import _ from 'lodash';
import addRoutes from './routes.js';

const isProduction = process.env.NODE_ENV === 'production';
const appPath = path.join(__dirname, '..');
const isDevelopment = !isProduction;

const setUpViews = app => {
  const domain = isDevelopment ? 'http://localhost:8080' : '';
  app.register(pointOfView, {
    engine: {
      pug: Pug
    },
    defaultContext: {
      assetPath: filename => `${domain}/assets/${filename}`
    },
    templates: path.join(__dirname, 'views')
  });
};

const setUpStaticAssets = app => {
  app.register(fastifyStatic, {
    root: path.join(appPath, 'dist/public'),
    prefix: '/assets'
  });
};

export default (options => {
  const app = fastify();

  setUpViews(app);
  setUpStaticAssets(app);

  const io = socket(app.server);
  addRoutes(app, io, options.state || {});

  return app;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJwYXRoIiwiUHVnIiwic29ja2V0IiwiZmFzdGlmeSIsInBvaW50T2ZWaWV3IiwiZmFzdGlmeVN0YXRpYyIsImFkZFJvdXRlcyIsImlzUHJvZHVjdGlvbiIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImFwcFBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwiaXNEZXZlbG9wbWVudCIsInNldFVwVmlld3MiLCJhcHAiLCJkb21haW4iLCJyZWdpc3RlciIsImVuZ2luZSIsInB1ZyIsImRlZmF1bHRDb250ZXh0IiwiYXNzZXRQYXRoIiwiZmlsZW5hbWUiLCJ0ZW1wbGF0ZXMiLCJzZXRVcFN0YXRpY0Fzc2V0cyIsInJvb3QiLCJwcmVmaXgiLCJvcHRpb25zIiwiaW8iLCJzZXJ2ZXIiLCJzdGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsT0FBTyxnQkFBUDtBQUNBLE9BQU8sNkJBQVA7O0FBRUEsT0FBT0EsSUFBUCxNQUFpQixNQUFqQjtBQUNBLE9BQU9DLEdBQVAsTUFBZ0IsS0FBaEI7QUFDQSxPQUFPQyxNQUFQLE1BQW1CLFdBQW5CO0FBQ0EsT0FBT0MsT0FBUCxNQUFvQixTQUFwQjtBQUNBLE9BQU9DLFdBQVAsTUFBd0IsZUFBeEI7QUFDQSxPQUFPQyxhQUFQLE1BQTBCLGdCQUExQjtBQUNBO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixhQUF0Qjs7QUFFQSxNQUFNQyxlQUFlQyxRQUFRQyxHQUFSLENBQVlDLFFBQVosS0FBeUIsWUFBOUM7QUFDQSxNQUFNQyxVQUFVWCxLQUFLWSxJQUFMLENBQVVDLFNBQVYsRUFBcUIsSUFBckIsQ0FBaEI7QUFDQSxNQUFNQyxnQkFBZ0IsQ0FBQ1AsWUFBdkI7O0FBRUEsTUFBTVEsYUFBY0MsR0FBRCxJQUFTO0FBQzFCLFFBQU1DLFNBQVNILGdCQUFnQix1QkFBaEIsR0FBMEMsRUFBekQ7QUFDQUUsTUFBSUUsUUFBSixDQUFhZCxXQUFiLEVBQTBCO0FBQ3hCZSxZQUFRO0FBQ05DLFdBQUtuQjtBQURDLEtBRGdCO0FBSXhCb0Isb0JBQWdCO0FBQ2RDLGlCQUFZQyxRQUFELElBQWUsR0FBRU4sTUFBTyxXQUFVTSxRQUFTO0FBRHhDLEtBSlE7QUFPeEJDLGVBQVd4QixLQUFLWSxJQUFMLENBQVVDLFNBQVYsRUFBcUIsT0FBckI7QUFQYSxHQUExQjtBQVNELENBWEQ7O0FBYUEsTUFBTVksb0JBQXFCVCxHQUFELElBQVM7QUFDakNBLE1BQUlFLFFBQUosQ0FBYWIsYUFBYixFQUE0QjtBQUMxQnFCLFVBQU0xQixLQUFLWSxJQUFMLENBQVVELE9BQVYsRUFBbUIsYUFBbkIsQ0FEb0I7QUFFMUJnQixZQUFRO0FBRmtCLEdBQTVCO0FBSUQsQ0FMRDs7QUFPQSxnQkFBZ0JDLE9BQUQsSUFBYTtBQUMxQixRQUFNWixNQUFNYixTQUFaOztBQUVBWSxhQUFXQyxHQUFYO0FBQ0FTLG9CQUFrQlQsR0FBbEI7O0FBRUEsUUFBTWEsS0FBSzNCLE9BQU9jLElBQUljLE1BQVgsQ0FBWDtBQUNBeEIsWUFBVVUsR0FBVixFQUFlYSxFQUFmLEVBQW1CRCxRQUFRRyxLQUFSLElBQWlCLEVBQXBDOztBQUVBLFNBQU9mLEdBQVA7QUFDRCxDQVZEIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLWNoZWNrXG5cbmltcG9ydCAnY29yZS1qcy9zdGFibGUnO1xuaW1wb3J0ICdyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUnO1xuXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBQdWcgZnJvbSAncHVnJztcbmltcG9ydCBzb2NrZXQgZnJvbSAnc29ja2V0LmlvJztcbmltcG9ydCBmYXN0aWZ5IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IHBvaW50T2ZWaWV3IGZyb20gJ3BvaW50LW9mLXZpZXcnO1xuaW1wb3J0IGZhc3RpZnlTdGF0aWMgZnJvbSAnZmFzdGlmeS1zdGF0aWMnO1xuLy8gaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhZGRSb3V0ZXMgZnJvbSAnLi9yb3V0ZXMuanMnO1xuXG5jb25zdCBpc1Byb2R1Y3Rpb24gPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nO1xuY29uc3QgYXBwUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicpO1xuY29uc3QgaXNEZXZlbG9wbWVudCA9ICFpc1Byb2R1Y3Rpb247XG5cbmNvbnN0IHNldFVwVmlld3MgPSAoYXBwKSA9PiB7XG4gIGNvbnN0IGRvbWFpbiA9IGlzRGV2ZWxvcG1lbnQgPyAnaHR0cDovL2xvY2FsaG9zdDo4MDgwJyA6ICcnO1xuICBhcHAucmVnaXN0ZXIocG9pbnRPZlZpZXcsIHtcbiAgICBlbmdpbmU6IHtcbiAgICAgIHB1ZzogUHVnLFxuICAgIH0sXG4gICAgZGVmYXVsdENvbnRleHQ6IHtcbiAgICAgIGFzc2V0UGF0aDogKGZpbGVuYW1lKSA9PiBgJHtkb21haW59L2Fzc2V0cy8ke2ZpbGVuYW1lfWAsXG4gICAgfSxcbiAgICB0ZW1wbGF0ZXM6IHBhdGguam9pbihfX2Rpcm5hbWUsICd2aWV3cycpLFxuICB9KTtcbn07XG5cbmNvbnN0IHNldFVwU3RhdGljQXNzZXRzID0gKGFwcCkgPT4ge1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgIHJvb3Q6IHBhdGguam9pbihhcHBQYXRoLCAnZGlzdC9wdWJsaWMnKSxcbiAgICBwcmVmaXg6ICcvYXNzZXRzJyxcbiAgfSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCAob3B0aW9ucykgPT4ge1xuICBjb25zdCBhcHAgPSBmYXN0aWZ5KCk7XG5cbiAgc2V0VXBWaWV3cyhhcHApO1xuICBzZXRVcFN0YXRpY0Fzc2V0cyhhcHApO1xuXG4gIGNvbnN0IGlvID0gc29ja2V0KGFwcC5zZXJ2ZXIpO1xuICBhZGRSb3V0ZXMoYXBwLCBpbywgb3B0aW9ucy5zdGF0ZSB8fCB7fSk7XG5cbiAgcmV0dXJuIGFwcDtcbn07XG4iXX0=